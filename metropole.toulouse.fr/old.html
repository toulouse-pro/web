<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>üéÑ Collecte Sapins - Joyeux No√´l !</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

<style>
  /* --- RESET & LAYOUT --- */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body {
    margin: 0; padding: 0;
    height: 100%; width: 100%;
    font-family: 'Quicksand', sans-serif; /* Cleaner, rounder font */
    background: linear-gradient(to bottom, #1a2a6c, #b21f1f, #fdbb2d); /* Christmas Night Gradient */
    background: #c0392b; /* Fallback Red */
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* --- SNOW ANIMATION --- */
  .snow-container {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 1;
    background-image: url('data:image/svg+xml;utf8,%3Csvg version="1.1" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"%3E%3Ccircle cx="10" cy="10" r="3" fill="white" opacity="0.3"/%3E%3C/svg%3E');
    animation: snow 10s linear infinite;
  }
  @keyframes snow {
    0% { background-position: 0 0; }
    100% { background-position: 50px 200px; }
  }

  /* --- HEADER --- */
  header {
    background: #165b33; /* Pine Green */
    border-bottom: 4px solid #f1c40f; /* Gold border */
    color: white;
    padding: 10px 15px;
    flex-shrink: 0;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: center;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  }
  header h1 { 
    margin: 0; 
    font-family: 'Mountains of Christmas', cursive; 
    font-size: 1.8rem; 
    font-weight: 700;
    letter-spacing: 1px;
  }

  /* --- CONTROLS --- */
  #controls {
    background: rgba(255, 255, 255, 0.95);
    padding: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    flex-shrink: 0;
    z-index: 10;
    align-items: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }

  #input-group {
    display: flex;
    flex: 1;
    gap: 8px;
    flex-wrap: wrap;
    min-width: 200px;
  }

  input {
    padding: 8px 15px;
    border: 2px solid #ddd;
    border-radius: 25px; /* Rounded pill shape */
    font-size: 14px;
    flex: 1;
    height: 45px;
    min-width: 150px;
    background: white;
    font-family: 'Quicksand', sans-serif;
    outline: none;
    transition: border-color 0.3s;
  }
  input:focus { border-color: #c0392b; }

  #btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

  button {
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    padding: 0 16px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
    transition: transform 0.2s, box-shadow 0.2s;
    font-family: 'Quicksand', sans-serif;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  button:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

  #btn-loc {
    background: #27ae60; /* Green */
    color: white;
  }
  #btn-loc:active { background: #1e8449; }

  #btn-recenter {
    background: #2980b9; /* Blue */
    color: white;
    display: none; 
  }
  #btn-recenter:active { background: #1f618d; }

  #btn-reset {
    background: #c0392b; /* Red */
    color: white;
  }
  #btn-reset:active { background: #922b21; }

  /* --- MAIN CONTENT --- */
  #content-area {
    display: flex;
    flex: 1;
    position: relative;
    overflow: hidden;
    z-index: 5; /* Below controls */
  }

  #map { flex: 1; height: 100%; width: 100%; }

  #results-container {
    width: 320px;
    background: white;
    border-left: 1px solid #ddd;
    display: none;
    flex-direction: column;
    overflow-y: auto;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
  }

  .list-header {
    background: #e74c3c; /* Red header for list */
    padding: 10px 15px;
    font-size: 1rem;
    font-family: 'Mountains of Christmas', cursive;
    font-weight: 700;
    letter-spacing: 1px;
    color: white;
    position: sticky;
    top: 0;
    text-align: center;
  }

  .result-item {
    padding: 15px;
    border-bottom: 1px solid #f1f1f1;
    cursor: pointer;
    transition: background 0.1s;
    position: relative;
  }
  .result-item:hover { background: #fff5f5; } /* Light red hover */
  
  .result-name { font-weight: 700; color: #2c3e50; margin-bottom: 5px; display: block; font-size: 1rem; }
  .result-addr { font-size: 0.85rem; color: #7f8c8d; display: block; }
  
  .dist-badge {
    float: right;
    background: #f1c40f; /* Gold Badge */
    color: #7f5c05;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  /* --- POPUP FIXES --- */
  .gm-style-iw-d { overflow: hidden !important; padding: 0 !important; }
  .gm-style-iw-c { padding: 0 !important; border-radius: 15px !important; }

  /* Close button styling */
  button.gm-ui-hover-effect {
    background: rgba(192, 57, 43, 0.1) !important; 
    border-radius: 50% !important;
    margin: 5px !important;
  }

  .custom-popup {
    padding: 15px;
    max-width: 260px; 
    font-family: 'Quicksand', sans-serif;
  }

  .custom-popup h3 { 
    margin: 0 0 6px; 
    font-size: 16px; 
    color: #c0392b; /* Santa Red */
    font-weight: 700;
  }
  
  .custom-popup p { 
    margin: 0 0 12px; 
    font-size: 13px; 
    color: #555; 
    line-height: 1.4; 
  }
  
  .popup-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #165b33; /* Tree Green */
    color: white !important;
    text-decoration: none;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    width: 100%;
    box-sizing: border-box;
    transition: background 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .popup-btn:hover { background: #14522d; }

  /* --- MOBILE TWEAKS --- */
  @media (max-width: 768px) {
    #controls { gap: 8px; padding: 10px; }
    #input-group { min-width: 100%; }
    #btn-group { width: 100%; gap: 8px; }
    button { flex: 1; } 
    
    #content-area { flex-direction: column; }
    #results-container {
      width: 100%;
      height: 40%;
      border-left: none;
      border-top: 4px solid #f1c40f;
    }
  }
</style>
</head>

<body>

<div class="snow-container"></div>

<header>
  <h1>üéÑ Collecte Sapins üéÖ</h1>
</header>

<div id="controls">
  <div id="input-group">
    <input id="address" type="text" placeholder="üè† Entrez votre adresse...">
  </div>
  
  <div id="btn-group">
    <button id="btn-loc">üìç Ma position</button>
    <button id="btn-recenter">üéØ Recentrer</button>
    <button id="btn-reset">üóëÔ∏è Effacer</button>
  </div>
</div>

<div id="content-area">
  <div id="map"></div>
  <div id="results-container">
    <div class="list-header">‚≠ê Points √† proximit√© ‚≠ê</div>
    <div id="results-list"></div>
  </div>
</div>

<script>
let map, userMarker, infoWindow;
let markers = [];
let allPoints = [];
let userLocation = null; 
let userAddressString = null; 

const DEFAULT_CENTER = { lat: 43.6045, lng: 1.444 };

// A nice clean map style to let the Christmas colors pop
const CHRISTMAS_MAP_STYLE = [
  { "featureType": "landscape", "stylers": [{ "saturation": -100 }, { "lightness": 65 }, { "visibility": "on" }] },
  { "featureType": "poi", "stylers": [{ "saturation": -100 }, { "lightness": 51 }, { "visibility": "simplified" }] },
  { "featureType": "road.highway", "stylers": [{ "saturation": -100 }, { "visibility": "simplified" }] },
  { "featureType": "road.arterial", "stylers": [{ "saturation": -100 }, { "lightness": 30 }, { "visibility": "on" }] },
  { "featureType": "road.local", "stylers": [{ "saturation": -100 }, { "lightness": 40 }, { "visibility": "on" }] },
  { "featureType": "transit", "stylers": [{ "saturation": -100 }, { "visibility": "simplified" }] },
  { "featureType": "administrative.province", "stylers": [{ "visibility": "off" }] },
  { "featureType": "water", "elementType": "labels", "stylers": [{ "visibility": "on" }, { "lightness": -25 }, { "saturation": -100 }] },
  { "featureType": "water", "elementType": "geometry", "stylers": [{ "hue": "#ffff00" }, { "lightness": -25 }, { "saturation": -97 }] }
];

// DICTIONARY: Convert Zip Codes to Town Names
const ZIP_TO_CITY = {
  "31000": "Toulouse", "31100": "Toulouse", "31200": "Toulouse", "31300": "Toulouse", "31400": "Toulouse", "31500": "Toulouse",
  "31130": "Balma", "31700": "Blagnac", "31770": "Colomiers", "31170": "Tournefeuille", "31270": "Cugnaux", 
  "31240": "L'Union", "31320": "Castanet-Tolosan", "31650": "Saint-Orens-de-Gameville", "31520": "Ramonville-Saint-Agne",
  "31140": "Saint-Alban", "31150": "Brugui√®res", "31270": "Villeneuve-Tolosane", "31830": "Plaisance-du-Touch",
  "31490": "Brax", "31790": "Saint-Jory", "31120": "Portet-sur-Garonne", "31450": "Ayguesvives", "31380": "Montastruc",
  "31620": "Castelnau-d'Estr√©tefonds", "31820": "Pibrac", "31840": "Aussonne", "31780": "Castelginest", "31180": "Castelmaurou",
  "31750": "Escalquens", "31600": "Seysses", "31470": "Fonsorbes", "31280": "Dr√©mil-Lafage", "31850": "Montrab√©",
  "31150": "Fenouillet", "31140": "Launaguet", "31790": "Saint-Sauveur", "31330": "Merville", "31700": "Beauzelle"
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: DEFAULT_CENTER,
    zoom: 11,
    disableDefaultUI: false,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false,
    clickableIcons: false,
    gestureHandling: "greedy",
    styles: CHRISTMAS_MAP_STYLE // Applied the Winter style
  });

  infoWindow = new google.maps.InfoWindow();

  setupAutocomplete();
  loadDataset();
  
  // Cleaned listeners (removed dropdown listener)
  document.getElementById("btn-reset").addEventListener("click", resetAll);
  document.getElementById("btn-recenter").addEventListener("click", recenterMap);
  document.getElementById("btn-loc").addEventListener("click", useGeolocation);
}

/* --- DATA LOADING --- */
async function loadDataset() {
  try {
    const url = "https://toulouse-metropole.opendatasoft.com/api/records/1.0/search/?dataset=collecte-des-sapins-de-noel&rows=1000";
    const res = await fetch(url);
    const data = await res.json();

    allPoints = data.records
      .filter(r => r.geometry)
      .map(r => {
        const f = r.fields;
        
        let determinedCity = f.commune;

        if (!determinedCity) {
           const address = f.adresse || f.localisation || "";
           const zipMatch = address.match(/\b(31\d{3})\b/); 
           if (zipMatch) {
             const zip = zipMatch[1];
             determinedCity = ZIP_TO_CITY[zip]; 
           }
        }

        if (!determinedCity) determinedCity = "Toulouse";

        let niceCity = determinedCity.charAt(0).toUpperCase() + determinedCity.slice(1).toLowerCase();
        
        if(niceCity.includes("L'union")) niceCity = "L'Union";
        if(niceCity.includes("Saint-orens")) niceCity = "Saint-Orens-de-Gameville";

        return {
          name: f.nom || f.libelle || "Point de collecte",
          address: f.adresse || f.localisation || "Adresse non pr√©cis√©e",
          commune: niceCity,
          lat: r.geometry.coordinates[1],
          lng: r.geometry.coordinates[0],
          marker: null
        };
      });

    // Removed populateDropdownDynamic(); 
    filterAndRender(false);

  } catch (e) {
    alert("Erreur de chargement des donn√©es.");
    console.error(e);
  }
}

/* --- LOGIC --- */
function filterAndRender(shouldFitBounds) {
  markers.forEach(m => m.setMap(null));
  markers = [];
  infoWindow.close();

  // Removed municipality filter logic.
  // We now simply use allPoints or a distance-sorted version of it.
  const listDiv = document.getElementById("results-list");
  listDiv.innerHTML = "";

  let visiblePoints = [...allPoints]; // Copy array

  // Sort
  if (userLocation) {
    visiblePoints.forEach(p => {
      p.distance = google.maps.geometry.spherical.computeDistanceBetween(
        userLocation, new google.maps.LatLng(p.lat, p.lng)
      );
    });
    visiblePoints.sort((a, b) => a.distance - b.distance);
  } else {
    visiblePoints.sort((a, b) => a.name.localeCompare(b.name));
  }

  // Render Markers
  const bounds = new google.maps.LatLngBounds();

  visiblePoints.forEach((p, idx) => {
    const marker = new google.maps.Marker({
      position: { lat: p.lat, lng: p.lng },
      map: map,
      title: p.name,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 6,
        fillColor: "#165b33", // CHRISTMAS TREE GREEN
        fillOpacity: 1,
        strokeWeight: 2,
        strokeColor: "#f1c40f" // GOLD STROKE
      }
    });

    marker.addListener("click", () => openPopup(p, marker));
    
    p.marker = marker;
    markers.push(marker);
    bounds.extend(marker.getPosition());

    // Populate List
    if (idx < 50) {
      document.getElementById("results-container").style.display = "flex";
      
      const item = document.createElement("div");
      item.className = "result-item";
      
      const distHtml = p.distance 
        ? `<span class="dist-badge">${(p.distance/1000).toFixed(1)} km</span>` 
        : "";

      item.innerHTML = `
        ${distHtml}
        <span class="result-name">üéÑ ${p.name}</span>
        <span class="result-addr">${p.address}</span>
      `;
      
      item.onclick = () => {
        openPopup(p, marker);
        map.panTo(marker.getPosition());
        map.setZoom(16);
      };
      
      listDiv.appendChild(item);
    }
  });

  if (markers.length > 0 && shouldFitBounds) {
    map.fitBounds(bounds);
    const listener = google.maps.event.addListener(map, "idle", () => { 
      if (map.getZoom() > 16) map.setZoom(16); 
      google.maps.event.removeListener(listener); 
    });
  }
}

function openPopup(p, marker) {
  let originParam = "";
  if (userAddressString) {
    originParam = `&origin=${encodeURIComponent(userAddressString)}`;
  } else if (userLocation) {
    originParam = `&origin=${userLocation.lat()},${userLocation.lng()}`;
  }

  const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}${originParam}`;

  const content = `
    <div class="custom-popup">
      <h3>üéÖ ${p.name}</h3>
      <p>
        ${p.address}<br>
        <strong>${p.commune}</strong>
      </p>
      <a href="${mapsUrl}" target="_blank" class="popup-btn">
        üéÅ Y aller
      </a>
    </div>
  `;
  
  infoWindow.setContent(content);
  infoWindow.open(map, marker);
}

function setupAutocomplete() {
  const input = document.getElementById("address");
  input.addEventListener("keydown", (e) => { if(e.key === "Enter") e.preventDefault(); });

  const autocomplete = new google.maps.places.Autocomplete(input, {
    componentRestrictions: { country: "fr" },
    fields: ["geometry", "formatted_address"]
  });

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;
    
    userAddressString = place.formatted_address; 
    setUserLocation(place.geometry.location);
  });
}

function useGeolocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const loc = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        userAddressString = null; 
        setUserLocation(loc);
      },
      () => alert("Impossible d'obtenir votre position.")
    );
  } else {
    alert("Votre navigateur ne supporte pas la g√©olocalisation.");
  }
}

function setUserLocation(loc) {
  userLocation = loc;
  
  if (userMarker) userMarker.setMap(null);
  userMarker = new google.maps.Marker({
    position: userLocation,
    map: map,
    title: "Vous √™tes ici",
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 8,
      fillColor: "#c0392b", // RUDOLPH RED
      fillOpacity: 1,
      strokeWeight: 3,
      strokeColor: "white"
    },
    zIndex: 999
  });

  document.getElementById("btn-recenter").style.display = "flex";
  recenterMap(); 
}

function recenterMap() {
  if (userLocation) {
    map.panTo(userLocation);
    map.setZoom(14);
    filterAndRender(false);
  }
}

function resetAll() {
  document.getElementById("address").value = "";
  // Removed municipality reset line
  document.getElementById("results-container").style.display = "none";
  document.getElementById("btn-recenter").style.display = "none";
  
  userLocation = null;
  userAddressString = null;
  if (userMarker) userMarker.setMap(null);
  
  map.setCenter(DEFAULT_CENTER);
  map.setZoom(11);
  
  filterAndRender(false);
}
</script>


<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcGEQLapcmMIZpljmgf58msdesktWBXPc&libraries=places,geometry&callback=initMap">
</script>

</body>
</html>
