<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Points de collecte Sapins - Toulouse M√©tropole</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
  /* --- RESET & LAYOUT --- */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body {
    margin: 0; padding: 0;
    height: 100%; width: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* --- HEADER --- */
  header {
    background: #2c3e50;
    color: white;
    padding: 10px 15px;
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    z-index: 20;
    display: flex;
    align-items: center;
  }
  header h1 { margin: 0; font-size: 1.1rem; font-weight: 600; }

  /* --- CONTROLS --- */
  #controls {
    background: white;
    padding: 10px;
    border-bottom: 1px solid #ddd;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    flex-shrink: 0;
    z-index: 10;
    align-items: center;
  }

  #input-group {
    display: flex;
    flex: 1;
    gap: 8px;
    flex-wrap: wrap;
    min-width: 260px;
  }

  input, select {
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    flex: 1;
    height: 40px;
    min-width: 130px;
    background: white;
  }

  #btn-group { display: flex; gap: 6px; flex-wrap: wrap; }

  button {
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    padding: 0 12px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    white-space: nowrap;
    transition: background 0.2s;
  }

  #btn-loc {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
  }
  #btn-loc:active { background: #c8e6c9; }

  #btn-recenter {
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #bbdefb;
    display: none; /* Hidden by default */
  }
  #btn-recenter:active { background: #bbdefb; }

  #btn-reset {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
  }
  #btn-reset:active { background: #ffcdd2; }

  /* --- MAIN CONTENT --- */
  #content-area {
    display: flex;
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  #map { flex: 1; height: 100%; width: 100%; }

  #results-container {
    width: 300px;
    background: white;
    border-left: 1px solid #ddd;
    display: none;
    flex-direction: column;
    overflow-y: auto;
    box-shadow: -2px 0 5px rgba(0,0,0,0.05);
  }

  .list-header {
    background: #f1f3f5;
    padding: 8px 12px;
    font-size: 0.85rem;
    font-weight: 700;
    color: #495057;
    position: sticky;
    top: 0;
    border-bottom: 1px solid #e9ecef;
  }

  .result-item {
    padding: 12px 12px;
    border-bottom: 1px solid #f1f1f1;
    cursor: pointer;
    transition: background 0.1s;
  }
  .result-item:hover { background: #f8f9fa; }
  
  .result-name { font-weight: 600; color: #343a40; margin-bottom: 3px; display: block; font-size: 0.95rem; }
  .result-addr { font-size: 0.8rem; color: #868e96; display: block; }
  .dist-badge {
    float: right;
    background: #e3f2fd;
    color: #1976d2;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  /* --- POPUP FIXES --- */
  .gm-style-iw-d { overflow: hidden !important; padding: 0 !important; }
  .gm-style-iw-c { padding: 0 !important; }

  button.gm-ui-hover-effect {
    top: 0px !important;
    right: 0px !important;
    width: 22px !important;
    height: 22px !important;
    background: rgba(255, 255, 255, 0.9) !important;
    border-radius: 50% !important;
    margin: 4px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  button.gm-ui-hover-effect img {
    width: 12px !important;
    height: 12px !important;
    margin: 5px !important;
  }

  .custom-popup {
    padding: 12px 12px 10px 12px;
    max-width: 240px; 
    font-family: sans-serif;
  }

  .custom-popup h3 { 
    margin: 0 0 4px; 
    font-size: 14px; 
    color: #2c3e50; 
    font-weight: 700;
    padding-right: 15px; 
  }
  
  .custom-popup p { 
    margin: 0 0 8px; 
    font-size: 12px; 
    color: #666; 
    line-height: 1.3; 
  }
  
  .popup-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #1976d2;
    color: white !important;
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 500;
    width: 100%;
    box-sizing: border-box;
    transition: background 0.2s;
  }
  .popup-btn:hover { background: #1565c0; }

  /* --- MOBILE TWEAKS --- */
  @media (max-width: 768px) {
    #controls { gap: 8px; }
    #input-group { min-width: 100%; gap: 8px; }
    #btn-group { width: 100%; gap: 8px; }
    button { flex: 1; } 
    
    #content-area { flex-direction: column; }
    #results-container {
      width: 100%;
      height: 40%;
      border-left: none;
      border-top: 1px solid #ddd;
    }
  }
</style>
</head>

<body>

<header>
  <h1>üå≤ Collecte Sapins</h1>
</header>

<div id="controls">
  <div id="input-group">
    <input id="address" type="text" placeholder="Entrez votre adresse...">
    <select id="municipality">
      <option value="">Toutes les communes</option>
    </select>
  </div>
  
  <div id="btn-group">
    <button id="btn-loc">üìç Ma position</button>
    <button id="btn-recenter">üéØ Recentrer</button>
    <button id="btn-reset">üóëÔ∏è Effacer</button>
  </div>
</div>

<div id="content-area">
  <div id="map"></div>
  <div id="results-container">
    <div class="list-header">Points √† proximit√©</div>
    <div id="results-list"></div>
  </div>
</div>

<script>
let map, userMarker, infoWindow;
let markers = [];
let allPoints = [];
let userLocation = null; 
let userAddressString = null; 

// Default: Place du Capitole
const DEFAULT_CENTER = { lat: 43.6045, lng: 1.444 };

// FALLBACK: Map Zip Codes to City Names in case the API misses the name
const ZIP_TO_CITY = {
  "31000": "Toulouse", "31100": "Toulouse", "31200": "Toulouse", "31300": "Toulouse", "31400": "Toulouse", "31500": "Toulouse",
  "31130": "Balma", "31700": "Blagnac", "31770": "Colomiers", "31170": "Tournefeuille", "31270": "Cugnaux", 
  "31240": "L'Union", "31320": "Castanet-Tolosan", "31650": "Saint-Orens-de-Gameville", "31520": "Ramonville-Saint-Agne",
  "31140": "Saint-Alban", "31150": "Brugui√®res", "31270": "Villeneuve-Tolosane", "31830": "Plaisance-du-Touch",
  "31490": "Brax", "31790": "Saint-Jory", "31120": "Portet-sur-Garonne", "31450": "Ayguesvives", "31380": "Montastruc",
  "31620": "Castelnau-d'Estr√©tefonds", "31820": "Pibrac", "31840": "Aussonne", "31780": "Castelginest", "31180": "Castelmaurou",
  "31750": "Escalquens", "31600": "Seysses", "31470": "Fonsorbes", "31280": "Dr√©mil-Lafage", "31850": "Montrab√©"
};

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: DEFAULT_CENTER,
    zoom: 11,
    disableDefaultUI: false,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false,
    clickableIcons: false,
    gestureHandling: "greedy" 
  });

  infoWindow = new google.maps.InfoWindow();

  setupAutocomplete();
  loadDataset();
  
  // Event Listeners
  document.getElementById("municipality").addEventListener("change", () => filterAndRender(true));
  document.getElementById("btn-reset").addEventListener("click", resetAll);
  document.getElementById("btn-recenter").addEventListener("click", recenterMap);
  document.getElementById("btn-loc").addEventListener("click", useGeolocation);
}

/* --- DATA LOADING --- */
async function loadDataset() {
  try {
    // We use the generic search API.
    const url = "https://toulouse-metropole.opendatasoft.com/api/records/1.0/search/?dataset=collecte-des-sapins-de-noel&rows=1000";
    const res = await fetch(url);
    const data = await res.json();

    allPoints = data.records
      .filter(r => r.geometry)
      .map(r => {
        const f = r.fields;
        
        // LOGIC: Try 'commune' -> Try 'ville' -> Try Zip Code -> Default to Toulouse
        let rawCity = f.commune || f.ville || f.commune_nom || ZIP_TO_CITY[f.code_postal] || "Toulouse";
        
        // Clean up string (Title Case)
        let niceCity = rawCity.charAt(0).toUpperCase() + rawCity.slice(1).toLowerCase();
        
        // Fix specific formatting issues
        if(niceCity.includes("L'union")) niceCity = "L'Union";
        if(niceCity.includes("Saint-orens")) niceCity = "Saint-Orens-de-Gameville";

        return {
          name: f.nom || f.libelle || "Point de collecte",
          address: f.adresse || f.localisation || "Adresse non pr√©cis√©e",
          commune: niceCity,
          lat: r.geometry.coordinates[1],
          lng: r.geometry.coordinates[0],
          marker: null,
          zip: f.code_postal
        };
      });

    populateDropdownDynamic();
    filterAndRender(false);

  } catch (e) {
    alert("Erreur: Impossible de charger les donn√©es. V√©rifiez votre connexion.");
    console.error(e);
  }
}

function populateDropdownDynamic() {
  const select = document.getElementById("municipality");
  select.innerHTML = '<option value="">Toutes les communes</option>';
  
  // Extract unique cities, sort them, and add to dropdown
  const cities = [...new Set(allPoints.map(p => p.commune))].sort((a, b) => a.localeCompare(b));
  
  cities.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });
}

/* --- LOGIC --- */
function filterAndRender(shouldFitBounds) {
  // 1. Clear Markers
  markers.forEach(m => m.setMap(null));
  markers = [];
  infoWindow.close();

  const selectedCommune = document.getElementById("municipality").value;
  const listDiv = document.getElementById("results-list");
  listDiv.innerHTML = "";

  // 2. Filter
  let visiblePoints = allPoints;
  if (selectedCommune) {
    visiblePoints = allPoints.filter(p => p.commune === selectedCommune);
  }

  // 3. Sort (by distance if User Location exists, else Alphabetical)
  if (userLocation) {
    visiblePoints.forEach(p => {
      p.distance = google.maps.geometry.spherical.computeDistanceBetween(
        userLocation, new google.maps.LatLng(p.lat, p.lng)
      );
    });
    visiblePoints.sort((a, b) => a.distance - b.distance);
  } else {
    visiblePoints.sort((a, b) => a.name.localeCompare(b.name));
  }

  // 4. Render
  const bounds = new google.maps.LatLngBounds();

  visiblePoints.forEach((p, idx) => {
    const marker = new google.maps.Marker({
      position: { lat: p.lat, lng: p.lng },
      map: map,
      title: p.name,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 6,
        fillColor: "#27ae60",
        fillOpacity: 1,
        strokeWeight: 1,
        strokeColor: "white"
      }
    });

    marker.addListener("click", () => openPopup(p, marker));
    
    p.marker = marker;
    markers.push(marker);
    bounds.extend(marker.getPosition());

    // Populate List (limit to 50 items for performance)
    if (idx < 50) {
      document.getElementById("results-container").style.display = "flex";
      
      const item = document.createElement("div");
      item.className = "result-item";
      
      const distHtml = p.distance 
        ? `<span class="dist-badge">${(p.distance/1000).toFixed(1)} km</span>` 
        : "";

      item.innerHTML = `
        ${distHtml}
        <span class="result-name">${p.name}</span>
        <span class="result-addr">${p.address}</span>
      `;
      
      item.onclick = () => {
        openPopup(p, marker);
        map.panTo(marker.getPosition());
        map.setZoom(16);
      };
      
      listDiv.appendChild(item);
    }
  });

  // 5. Fit Bounds
  if (markers.length > 0 && shouldFitBounds) {
    map.fitBounds(bounds);
    const listener = google.maps.event.addListener(map, "idle", () => { 
      if (map.getZoom() > 16) map.setZoom(16); 
      google.maps.event.removeListener(listener); 
    });
  } else if (selectedCommune && markers.length === 0) {
    alert("Aucun point trouv√© pour cette s√©lection.");
  }
}

function openPopup(p, marker) {
  let originParam = "";
  if (userAddressString) {
    originParam = `&origin=${encodeURIComponent(userAddressString)}`;
  } else if (userLocation) {
    originParam = `&origin=${userLocation.lat()},${userLocation.lng()}`;
  }

  // Fix: Use correct Google Maps URL format
  const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}${originParam}&travelmode=driving`;

  const content = `
    <div class="custom-popup">
      <h3>${p.name}</h3>
      <p>
        ${p.address}<br>
        <strong>${p.commune}</strong>
      </p>
      <a href="${mapsUrl}" target="_blank" class="popup-btn">
        üöò Itin√©raire
      </a>
    </div>
  `;
  
  infoWindow.setContent(content);
  infoWindow.open(map, marker);
}

/* --- HELPERS --- */

function setupAutocomplete() {
  const input = document.getElementById("address");
  input.addEventListener("keydown", (e) => { if(e.key === "Enter") e.preventDefault(); });

  const autocomplete = new google.maps.places.Autocomplete(input, {
    componentRestrictions: { country: "fr" },
    fields: ["geometry", "formatted_address"]
  });

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;
    
    userAddressString = place.formatted_address; 
    setUserLocation(place.geometry.location);
  });
}

function useGeolocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const loc = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        userAddressString = null; 
        setUserLocation(loc);
      },
      () => alert("Impossible d'obtenir votre position.")
    );
  } else {
    alert("Votre navigateur ne supporte pas la g√©olocalisation.");
  }
}

function setUserLocation(loc) {
  userLocation = loc;
  
  if (userMarker) userMarker.setMap(null);
  userMarker = new google.maps.Marker({
    position: userLocation,
    map: map,
    title: "Vous √™tes ici",
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 8,
      fillColor: "#4285F4",
      fillOpacity: 1,
      strokeWeight: 2,
      strokeColor: "white"
    },
    zIndex: 999
  });

  document.getElementById("btn-recenter").style.display = "flex";
  recenterMap(); 
}

function recenterMap() {
  if (userLocation) {
    document.getElementById("municipality").value = ""; 
    map.panTo(userLocation);
    map.setZoom(14);
    filterAndRender(false);
  }
}

function resetAll() {
  document.getElementById("address").value = "";
  document.getElementById("municipality").value = "";
  document.getElementById("results-container").style.display = "none";
  document.getElementById("btn-recenter").style.display = "none";
  
  userLocation = null;
  userAddressString = null;
  if (userMarker) userMarker.setMap(null);
  
  map.setCenter(DEFAULT_CENTER);
  map.setZoom(11);
  
  filterAndRender(false);
}
</script>


<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcGEQLapcmMIZpljmgf58msdesktWBXPc&libraries=places,geometry&callback=initMap">
</script>

</body>
</html>
