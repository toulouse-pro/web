<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Carte des points de collecte des sapins – Toulouse Métropole</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #fafafa; }
    header { background: #1f6fb2; color: white; padding: 12px; }
    header h1 { margin: 0; font-size: 18px; }
    #controls { padding: 10px; background: white; }
    #address, #use-location { width: 100%; padding: 10px; font-size: 15px; box-sizing: border-box; margin-bottom:10px; }
    #map { width: 100%; height: 65vh; }
    #results { padding: 10px; background: white; font-size: 14px; }
    .result { padding: 8px 6px; border-bottom: 1px solid #eee; cursor: pointer; }
    .result:hover { background: #f0f0f0; }
    footer { padding: 10px; font-size: 12px; text-align:center; color:#555; }
  </style>
</head>

<body>

<header>
  <h1>Points de collecte des sapins de Noël – Toulouse Métropole</h1>
</header>

<div id="controls">
  <input id="address" type="text" placeholder="Entrez votre adresse">
  <button id="use-location">Utiliser ma position</button>
</div>

<div id="map"></div>

<div id="results">
  <strong>Points les plus proches :</strong>
</div>

<footer>
  Données officielles issues de Toulouse Métropole – Valide pour la campagne sapins 2025-2026. Carte non officielle.
</footer>

<script>
  let map, userMarker, markers = [], points = [];

  function initMap() {
    // Initialize Google Maps
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 43.6045, lng: 1.444 },
      zoom: 12,
      gestureHandling: "greedy",
      zoomControl: true,
      fullscreenControl: true,
    });

    // Load sapin collection points from official dataset
    fetchSapinPoints();

    // Autocomplete search
    const input = document.getElementById("address");
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo("bounds", map);
    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) return;
      displayUserLocation(place.geometry.location);
      showNearest(place.geometry.location);
    });

    // Use my location
    document.getElementById("use-location").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          displayUserLocation(loc);
          showNearest(loc);
        });
      }
    });
  }

  function fetchSapinPoints() {
    const url = "https://toulouse-metropole.opendatasoft.com/api/records/1.0/search/?dataset=collecte-des-sapins-de-noel&rows=500";
    fetch(url)
      .then(resp => resp.json())
      .then(data => {
        data.records.forEach(r => {
          if (r.geometry) {
            points.push({
              name: r.fields.nom_du_point || "Point de collecte",
              lat: r.geometry.coordinates[1],
              lng: r.geometry.coordinates[0]
            });
          }
        });
        placeMarkers();
      })
      .catch(err => console.error("Erreur chargement dataset:", err));
  }

  function placeMarkers() {
    const bounds = new google.maps.LatLngBounds();
    points.forEach(p => {
      const marker = new google.maps.Marker({
        position: { lat: p.lat, lng: p.lng },
        map,
        title: p.name,
        icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
      });
      markers.push(marker);
      bounds.extend(marker.getPosition());
    });
    map.fitBounds(bounds);
  }

  function displayUserLocation(loc) {
    if (userMarker) userMarker.setMap(null);
    userMarker = new google.maps.Marker({
      position: loc,
      map,
      icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
    });
    map.panTo(loc);
    map.setZoom(14);
  }

  function showNearest(location) {
    const resultsEl = document.getElementById("results");
    resultsEl.innerHTML = "<strong>Points les plus proches :</strong>";

    const sorted = points.map(p => {
      const dist = google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(location),
        new google.maps.LatLng(p.lat, p.lng)
      );
      return {...p, dist};
    }).sort((a,b) => a.dist - b.dist);

    sorted.slice(0, 8).forEach(p => {
      const div = document.createElement("div");
      div.className = "result";
      div.textContent = `${p.name} – ${(p.dist/1000).toFixed(2)} km`;
      div.addEventListener("click", () => {
        map.panTo({lat: p.lat, lng: p.lng});
        map.setZoom(16);
      });
      resultsEl.appendChild(div);
    });
  }
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcGEQLapcmMIZpljmgf58msdesktWBXPc&libraries=places,geometry&callback=initMap"></script>

</body>
</html>
