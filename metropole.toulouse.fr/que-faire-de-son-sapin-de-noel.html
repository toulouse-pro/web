<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Points de collecte des sapins â€“ Toulouse MÃ©tropole</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
html, body {
  margin:0;
  height:100%;
  font-family:Arial, sans-serif;
  background:#f7f7f7;
}

body {
  display:grid;
  grid-template-rows:auto auto 1fr auto;
  height:100dvh;
}

header {
  background:#1f6fb2;
  color:white;
  padding:12px;
}

header h1 {
  margin:0;
  font-size:18px;
}

#controls {
  background:white;
  padding:10px;
  border-bottom:1px solid #ddd;
}

#controls input,
#controls select,
#controls button {
  width:100%;
  padding:11px;
  font-size:15px;
  margin-bottom:8px;
  box-sizing:border-box;
}

#map {
  width:100%;
  min-height:200px;
}

#results {
  background:white;
  padding:10px;
  font-size:14px;
  overflow-y:auto;
  max-height:35vh;
}

.result {
  padding:10px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}

.result:hover {
  background:#f0f0f0;
}

footer {
  padding:8px;
  font-size:12px;
  text-align:center;
  color:#666;
  background:#fafafa;
}
</style>
</head>

<body>

<header>
  <h1>Points de collecte des sapins â€“ Toulouse MÃ©tropole</h1>
</header>

<div id="controls">
  <input id="address" type="text" placeholder="ðŸ“ Entrez votre adresse">
  <select id="municipality">
    <option value="">Toutes les communes</option>
  </select>
  <button id="use-location">Utiliser ma position</button>
  <button id="reset">RÃ©initialiser</button>
</div>

<div id="map"></div>

<div id="results">
  <strong>Points les plus proches :</strong>
</div>

<footer>
  DonnÃ©es Toulouse MÃ©tropole â€“ Carte non officielle
</footer>

<script>
let map, userMarker, highlightedMarker;
let userLocation = null;

const DEFAULT_LOCATION = new google.maps.LatLng(43.6045, 1.444);

let allPoints = [];
let filteredPoints = [];
let markers = [];

const ICONS = {
  normal: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
  best: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
  user: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
};

/* ---------- MAP INIT ---------- */

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: DEFAULT_LOCATION,
    zoom: 13,
    gestureHandling: "greedy"
  });

  setupSearch();
  setupControls();
  loadDataset();
}

/* ---------- SEARCH ---------- */

function setupSearch() {
  const autocomplete = new google.maps.places.Autocomplete(
    document.getElementById("address"),
    { componentRestrictions:{ country:"fr" } }
  );

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;

    userLocation = place.geometry.location;
    placeUserMarker(userLocation);
    updateResults(true);
  });

  document.getElementById("use-location").onclick = () => {
    navigator.geolocation.getCurrentPosition(
      pos => {
        userLocation = new google.maps.LatLng(
          pos.coords.latitude,
          pos.coords.longitude
        );
        placeUserMarker(userLocation);
        updateResults(true);
      },
      () => alert("Impossible d'obtenir votre position")
    );
  };
}

/* ---------- CONTROLS ---------- */

function setupControls() {
  document.getElementById("municipality").onchange = applyMunicipalityFilter;
  document.getElementById("reset").onclick = resetAll;
}

/* ---------- DATA ---------- */

async function loadDataset() {
  const res = await fetch(
    "https://toulouse-metropole.opendatasoft.com/api/records/1.0/search/?dataset=collecte-des-sapins-de-noel&rows=200"
  );
  const data = await res.json();

  const raw = data.records
    .filter(r => r.geometry)
    .map(r => ({
      name: r.fields.nom || "Point de collecte",
      address: r.fields.adresse || "",
      lat: r.geometry.coordinates[1],
      lng: r.geometry.coordinates[0],
      commune: null,
      marker: null
    }));

  for (const p of raw) {
    try {
      const r = await fetch(
        `https://api-adresse.data.gouv.fr/reverse/?lat=${p.lat}&lon=${p.lng}`
      );
      const g = await r.json();
      p.commune = g.features?.[0]?.properties?.city || "Inconnu";
    } catch {
      p.commune = "Inconnu";
    }
  }

  allPoints = raw;
  populateMunicipalities();
  applyMunicipalityFilter();

  // ðŸ”‘ INITIAL AUTO-TRIGGER
  userLocation = DEFAULT_LOCATION;
  updateResults(true);
}

/* ---------- MUNICIPALITIES ---------- */

function populateMunicipalities() {
  const select = document.getElementById("municipality");
  [...new Set(allPoints.map(p => p.commune))]
    .sort()
    .forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      select.appendChild(opt);
    });
}

/* ---------- FILTER ---------- */

function applyMunicipalityFilter() {
  const val = document.getElementById("municipality").value;
  filteredPoints = val
    ? allPoints.filter(p => p.commune === val)
    : [...allPoints];

  clearMarkers();
  createMarkers(filteredPoints);
}

/* ---------- MARKERS ---------- */

function createMarkers(list) {
  list.forEach(p => {
    p.marker = new google.maps.Marker({
      position:{ lat:p.lat, lng:p.lng },
      map,
      icon:ICONS.normal
    });
    markers.push(p.marker);
  });
}

function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
  resetHighlight();
}

function placeUserMarker(loc) {
  if (userMarker) userMarker.setMap(null);
  userMarker = new google.maps.Marker({
    position:loc,
    map,
    icon:ICONS.user
  });
}

/* ---------- RESULTS ---------- */

function updateResults(zoom) {
  resetHighlight();
  const results = document.getElementById("results");
  results.innerHTML = "<strong>Points les plus proches :</strong>";

  if (!userLocation) return;

  const sorted = filteredPoints
    .map(p => ({
      ...p,
      distance: google.maps.geometry.spherical.computeDistanceBetween(
        userLocation,
        new google.maps.LatLng(p.lat,p.lng)
      )
    }))
    .sort((a,b) => a.distance - b.distance);

  if (!sorted.length) return;

  const best = sorted[0];
  highlightedMarker = best.marker;
  highlightedMarker.setIcon(ICONS.best);

  if (zoom) {
    map.panTo({lat:best.lat,lng:best.lng});
    map.setZoom(15);
  }

  sorted.slice(0,8).forEach(p => {
    const d = document.createElement("div");
    d.className = "result";
    d.innerHTML = `
      <strong>${p.name}</strong><br>
      ${p.address}<br>
      ${p.commune} â€“ ${(p.distance/1000).toFixed(2)} km
    `;
    results.appendChild(d);
  });
}

function resetHighlight() {
  if (highlightedMarker) {
    highlightedMarker.setIcon(ICONS.normal);
    highlightedMarker = null;
  }
}

/* ---------- RESET ---------- */

function resetAll() {
  document.getElementById("municipality").value = "";
  document.getElementById("address").value = "";
  userLocation = DEFAULT_LOCATION;
  if (userMarker) userMarker.setMap(null);
  applyMunicipalityFilter();
  updateResults(true);
}
</script>

<script
async defer
src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY&libraries=places,geometry&callback=initMap">
</script>

</body>
</html>
