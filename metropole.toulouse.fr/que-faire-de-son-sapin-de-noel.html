<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <title>Carte interactive : O√π recycler son sapin √† Toulouse ?</title>
    <link rel="canonical" href="https://31000web.com/metropole.toulouse.fr/carte-sapins-2026.html" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Quicksand:wght@500;700&family=Courier+New&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. BLOG THEME
           ========================================= */
        :root {
            --bg-color: #f0f0f0;
            --card-bg: #ffffff;
            --ink: #1a1a1a;
            --accent: #9d4edd;
            --border-thick: 3px solid var(--ink);
            --shadow-hard: 6px 6px 0px var(--ink);
            --font-main: 'Courier New', Courier, monospace;
            --blog-padding: 2rem 2rem; 
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0;
            font-family: var(--font-main);
            color: var(--ink);
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--ink) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow-x: hidden;
        }

        /* HEADER */
        header.blog-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.5rem 2rem; background: var(--card-bg);
            border-bottom: var(--border-thick); position: sticky; top: 0; z-index: 100;
        }
        .logo {
            font-weight: 900; font-size: 1.2rem; text-transform: uppercase;
            background: var(--ink); color: var(--card-bg);
            padding: 5px 10px; transform: rotate(-1deg);
        }
        .btn-nav {
            text-decoration: none; color: var(--ink); font-weight: bold;
            text-transform: uppercase; padding: 10px 20px; font-size: 0.9rem;
            border: var(--border-thick); background: var(--accent);
            box-shadow: 4px 4px 0px var(--ink);
        }

        /* ARTICLE */
        .blog-container { max-width: 900px; margin: 4rem auto; padding: 0 1rem; }
        article {
            background: var(--card-bg); border: var(--border-thick);
            box-shadow: var(--shadow-hard); position: relative;
            overflow: hidden; 
        }
        .post-meta {
            position: absolute; top: -15px; left: -10px;
            background: var(--ink); color: #fff; padding: 5px 10px;
            font-size: 0.8rem; border: 2px solid var(--accent);
            transform: rotate(-2deg); z-index: 50;
        }

        .blog-text-block { padding: var(--blog-padding); }
        .blog-text-block h1 { font-size: 2rem; margin-bottom: 1.5rem; border-bottom: 4px solid var(--accent); display: inline-block; }
        .blog-text-block h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 1.1rem; }
        .blog-text-block p, .blog-text-block li { font-size: 1rem; line-height: 1.6; margin-bottom: 1rem; }
        .blog-image {
            width: 100%; height: auto; display: block;
            border: var(--border-thick); box-shadow: 4px 4px 0px var(--ink);
            margin: 2rem 0;
        }
        .interaction-bar {
            border-top: var(--border-thick); background: #fafafa;
            padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center;
        }
        code { background: #eee; padding: 2px 5px; border: 1px solid var(--ink); font-size: 0.9em; }

        /* =========================================
           2. MAP STYLES
           ========================================= */
        .map-app-wrapper {
            border-top: var(--border-thick); border-bottom: var(--border-thick);
            display: flex; flex-direction: column; position: relative;
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(to bottom, #1a2a6c, #b21f1f, #fdbb2d);
            overflow: hidden;
            height: 75vh; min-height: 500px;
        }

        .snow-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
            background-image: url('data:image/svg+xml;utf8,%3Csvg version="1.1" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"%3E%3Ccircle cx="10" cy="10" r="3" fill="white" opacity="0.3"/%3E%3C/svg%3E');
            animation: snow 10s linear infinite;
        }
        @keyframes snow { 0% { background-position: 0 0; } 100% { background-position: 50px 200px; } }

        .app-header {
            background: #165b33; border-bottom: 4px solid #f1c40f; 
            color: white; padding: 10px; flex-shrink: 0; z-index: 20; text-align: center;
        }
        .app-header h1 { 
            margin: 0; font-family: 'Mountains of Christmas', cursive; 
            font-size: 1.8rem; font-weight: 700;
        }

        #controls {
            background: rgba(255, 255, 255, 0.95); padding: 12px;
            display: flex; flex-wrap: wrap; gap: 10px;
            flex-shrink: 0; z-index: 10; align-items: center;
        }
        #input-group { display: flex; flex: 1; min-width: 200px; }
        input.map-input {
            padding: 8px 15px; border: 2px solid #ddd; border-radius: 25px;
            font-size: 14px; flex: 1; height: 45px;
            background: white; outline: none;
        }
        #btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        button.map-btn {
            border: none; border-radius: 25px; cursor: pointer;
            font-size: 14px; font-weight: 700; padding: 0 16px; height: 45px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            white-space: nowrap; font-family: 'Quicksand', sans-serif;
        }
        #btn-loc { background: #27ae60; color: white; }
        #btn-recenter { background: #2980b9; color: white; display: none; }
        #btn-reset { background: #c0392b; color: white; }

        #content-area { display: flex; flex: 1; position: relative; overflow: hidden; z-index: 5; }
        #map { flex: 1; height: 100%; width: 100%; }

        #results-container {
            width: 320px; background: white; border-left: 1px solid #ddd;
            display: none; flex-direction: column; overflow-y: auto;
        }
        .list-header {
            background: #e74c3c; padding: 10px; font-size: 1rem;
            font-family: 'Mountains of Christmas', cursive; font-weight: 700;
            color: white; text-align: center; position: sticky; top: 0;
        }
        .result-item { padding: 15px; border-bottom: 1px solid #f1f1f1; cursor: pointer; }
        .result-name { font-weight: 700; display: block; font-size: 1rem; }
        .result-addr { font-size: 0.85rem; color: #7f8c8d; }

        /* =========================================
           3. POPUP SCROLL FIXES
           ========================================= */
        
        /* 1. Force the Google internal container to scroll if needed */
        .gm-style-iw-d {
            overflow-y: auto !important; 
            max-height: 250px !important; /* Cap height to ensure it fits mobile */
        }
        
        /* 2. Style the popup content */
        .custom-popup {
            padding: 5px 5px 10px 5px; 
            max-width: 260px; 
            font-family: 'Quicksand', sans-serif; 
        }
        .custom-popup h3 { margin: 0 0 8px; font-size: 1.1rem; color: #c0392b; font-weight: 700; }
        .custom-popup p { margin: 0 0 15px; font-size: 0.9rem; color: #555; line-height: 1.4; }
        
        /* 3. High visibility button */
        .popup-btn {
            display: flex; align-items: center; justify-content: center;
            background: #165b33; color: white !important; text-decoration: none;
            padding: 10px 0; border-radius: 8px; /* Block shape */
            font-size: 0.95rem; font-weight: 700;
            width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-top: 5px;
        }
        .popup-btn:hover { background: #14522d; }

        @media (max-width: 768px) {
            .blog-container { margin: 2rem auto; }
            #content-area { flex-direction: column; }
            #results-container { width: 100%; height: 40%; border-left: none; border-top: 4px solid #f1c40f; }
            
            /* Bigger scroll target on mobile */
            .gm-style-iw-d { -webkit-overflow-scrolling: touch; }
        }
    </style>
</head>
<body>

    <header class="blog-header">
        <div class="logo">31000 Web Creation</div>
        <a href="/blog/blog.html" class="btn-nav">‚Üê Retour au Blog</a>
    </header>

    <main class="blog-container">
        <article>
            <div class="post-meta">JAN 2026</div>
            <div class="blog-text-block">
                <h1>O√π donner une seconde vie √† votre sapin ?</h1>
                <p>Les f√™tes sont finies. Votre sapin perd ses √©pines. Plut√¥t que de l'abandonner sur un trottoir, offrez-lui une sortie digne de ce nom !</p>
                <img src="https://source.unsplash.com/random/900x450/?christmas,tree,winter" alt="Sapin" class="blog-image">
                <p><strong>Utilisez la carte ci-dessous :</strong> Cliquez sur un sapin pour obtenir l'itin√©raire GPS direct.</p>
            </div>

            <div class="map-app-wrapper">
                <div class="snow-container"></div>
                <div class="app-header"><h1>üéÑ Carte des Sapins üéÖ</h1></div>
                <div id="controls">
                    <div id="input-group">
                        <input id="address" class="map-input" type="text" placeholder="üè† Votre adresse...">
                    </div>
                    <div id="btn-group">
                        <button id="btn-loc" class="map-btn">üìç Ma position</button>
                        <button id="btn-recenter" class="map-btn">üéØ Recentrer</button>
                        <button id="btn-reset" class="map-btn">üóëÔ∏è Effacer</button>
                    </div>
                </div>
                <div id="content-area">
                    <div id="map"></div>
                    <div id="results-container">
                        <div class="list-header">‚≠ê Points √† proximit√© ‚≠ê</div>
                        <div id="results-list"></div>
                    </div>
                </div>
            </div>

            <div class="blog-text-block">
                <h3>Consignes de tri</h3>
                <p>Pour √™tre accept√©, votre sapin doit √™tre :</p>
                <ul>
                    <li><strong>Nu :</strong> Sans d√©corations.</li>
                    <li><strong>Sans sac :</strong> Sauf sac Handicap International.</li>
                    <li><strong>Naturel :</strong> Pas de neige artificielle.</li>
                </ul>
                <img src="https://source.unsplash.com/random/900x450/?forest,recycling" alt="Recyclage" class="blog-image">
                <p>Merci pour votre geste √©cologique !</p>
            </div>

            <div class="interaction-bar">
                <div class="tags"><code>#toulouse</code> <code>#recyclage</code></div>
                <div style="font-weight: bold; font-size: 0.8rem;">Donn√©es : OpenData Toulouse</div>
            </div>
               <div style="padding: 2rem; border-top: 3px solid #1a1a1a;">
                <script src="https://utteranc.es/client.js"
                        repo="toulouse-pro/blog-comments"
                        issue-term="pathname"
                        label="comment"
                        theme="github-light"
                        crossorigin="anonymous"
                        async>
                </script>
            </div>
        </article>
    </main>

    <script>
    let map, userMarker, infoWindow, userLocation = null, userAddressString = null;
    let markers = [];
    let allPoints = [];

    const DEFAULT_CENTER = { lat: 43.6045, lng: 1.444 };
    const ZIP_TO_CITY = { "31000": "Toulouse", "31100": "Toulouse", "31200": "Toulouse", "31300": "Toulouse", "31400": "Toulouse", "31500": "Toulouse", "31130": "Balma", "31700": "Blagnac", "31770": "Colomiers", "31170": "Tournefeuille", "31270": "Cugnaux", "31240": "L'Union", "31320": "Castanet-Tolosan", "31650": "Saint-Orens", "31520": "Ramonville", "31140": "Saint-Alban", "31150": "Brugui√®res", "31830": "Plaisance", "31490": "Brax", "31790": "Saint-Jory", "31120": "Portet", "31820": "Pibrac", "31840": "Aussonne", "31780": "Castelginest", "31750": "Escalquens", "31600": "Seysses", "31470": "Fonsorbes", "31850": "Montrab√©" };

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: DEFAULT_CENTER, zoom: 11, disableDefaultUI: false, mapTypeControl: false, streetViewControl: false, fullscreenControl: false, clickableIcons: false, gestureHandling: "greedy",
            styles: [
              { "featureType": "landscape", "stylers": [{ "saturation": -100 }, { "lightness": 65 }, { "visibility": "on" }] },
              { "featureType": "poi", "stylers": [{ "saturation": -100 }, { "lightness": 51 }, { "visibility": "simplified" }] },
              { "featureType": "road.highway", "stylers": [{ "saturation": -100 }, { "visibility": "simplified" }] },
              { "featureType": "road.arterial", "stylers": [{ "saturation": -100 }, { "lightness": 30 }, { "visibility": "on" }] },
              { "featureType": "road.local", "stylers": [{ "saturation": -100 }, { "lightness": 40 }, { "visibility": "on" }] },
              { "featureType": "water", "elementType": "geometry", "stylers": [{ "hue": "#ffff00" }, { "lightness": -25 }, { "saturation": -97 }] }
            ]
        });
        infoWindow = new google.maps.InfoWindow();
        setupAutocomplete();
        loadDataset();

        document.getElementById("btn-reset").addEventListener("click", resetAll);
        document.getElementById("btn-recenter").addEventListener("click", recenterMap);
        document.getElementById("btn-loc").addEventListener("click", useGeolocation);
    }

    async function loadDataset() {
        try {
            const res = await fetch("https://toulouse-metropole.opendatasoft.com/api/records/1.0/search/?dataset=collecte-des-sapins-de-noel&rows=1000");
            const data = await res.json();
            allPoints = data.records.filter(r => r.geometry).map(r => {
                const f = r.fields;
                let city = f.commune;
                if (!city) {
                    const m = (f.adresse||f.localisation||"").match(/\b(31\d{3})\b/);
                    if(m) city = ZIP_TO_CITY[m[1]];
                }
                return {
                    name: f.nom || f.libelle || "Point de collecte",
                    address: f.adresse || f.localisation || "Adresse non pr√©cis√©e",
                    commune: (city || "Toulouse"),
                    lat: r.geometry.coordinates[1],
                    lng: r.geometry.coordinates[0]
                };
            });
            filterAndRender(false);
        } catch (e) { console.error(e); }
    }

    function filterAndRender(fit) {
        markers.forEach(m => m.setMap(null)); markers = [];
        const listDiv = document.getElementById("results-list"); listDiv.innerHTML = "";
        
        let visible = [...allPoints];
        if (userLocation) {
            visible.forEach(p => p.dist = google.maps.geometry.spherical.computeDistanceBetween(userLocation, new google.maps.LatLng(p.lat, p.lng)));
            visible.sort((a, b) => a.dist - b.dist);
        } else { visible.sort((a, b) => a.name.localeCompare(b.name)); }

        const bounds = new google.maps.LatLngBounds();
        visible.forEach((p, idx) => {
            const m = new google.maps.Marker({
                position: { lat: p.lat, lng: p.lng }, map: map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: "#165b33", fillOpacity: 1, strokeWeight: 2, strokeColor: "#f1c40f" }
            });
            m.addListener("click", () => openPopup(p, m));
            markers.push(m); bounds.extend(m.getPosition());

            if (idx < 50) {
                document.getElementById("results-container").style.display = "flex";
                const item = document.createElement("div"); item.className = "result-item";
                item.innerHTML = `${p.dist ? `<span class="dist-badge">${(p.dist/1000).toFixed(1)} km</span>` : ""}
                                  <span class="result-name">üéÑ ${p.name}</span><span class="result-addr">${p.address}</span>`;
                item.onclick = () => { openPopup(p, m); };
                listDiv.appendChild(item);
            }
        });
        if (markers.length > 0 && fit) map.fitBounds(bounds);
    }

    function openPopup(p, marker) {
        // Universal Cross-Platform Link (Works better on Mobile)
        const baseUrl = "https://www.google.com/maps/dir/?api=1";
        const dest = `&destination=${p.lat},${p.lng}`;
        let origin = "";
        if (userAddressString) origin = `&origin=${encodeURIComponent(userAddressString)}`;
        else if (userLocation) origin = `&origin=${userLocation.lat()},${userLocation.lng()}`;

        const fullUrl = `${baseUrl}${dest}${origin}`;

        const content = `
            <div class="custom-popup">
                <h3>üéÖ ${p.name}</h3>
                <p>
                    ${p.address}<br>
                    <strong>${p.commune}</strong>
                </p>
                <a href="${fullUrl}" target="_blank" class="popup-btn">
                    ‚û°Ô∏è Voir l'itin√©raire
                </a>
            </div>
        `;
        
        infoWindow.setContent(content);
        infoWindow.open(map, marker);

        // SMART PAN: Move map down so popup isn't cut off at the top
        // This calculates a position slightly 'North' of the marker to be the new center
        const latOffset = 0.006; // Roughly 500m-800m offset depending on zoom
        const newCenter = { lat: p.lat + latOffset, lng: p.lng };
        map.panTo(newCenter);
        map.setZoom(15);
    }

    function setupAutocomplete() {
        const input = document.getElementById("address");
        const ac = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: "fr" }, fields: ["geometry", "formatted_address"] });
        ac.addListener("place_changed", () => {
            const p = ac.getPlace();
            if (!p.geometry) return;
            userAddressString = p.formatted_address; setUserLocation(p.geometry.location);
        });
    }

    function useGeolocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                userAddressString = null; setUserLocation(new google.maps.LatLng(p.coords.latitude, p.coords.longitude));
            }, () => alert("Erreur g√©olocalisation"));
        } else alert("Non support√©");
    }

    function setUserLocation(loc) {
        userLocation = loc;
        if (userMarker) userMarker.setMap(null);
        userMarker = new google.maps.Marker({ position: loc, map: map, zIndex: 999, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#c0392b", fillOpacity: 1, strokeWeight: 3, strokeColor: "white" } });
        document.getElementById("btn-recenter").style.display = "flex";
        recenterMap();
    }

    function recenterMap() { if(userLocation) { map.panTo(userLocation); map.setZoom(14); filterAndRender(false); } }
    function resetAll() {
        document.getElementById("address").value = "";
        document.getElementById("results-container").style.display = "none";
        document.getElementById("btn-recenter").style.display = "none";
        userLocation = null; userAddressString = null; if (userMarker) userMarker.setMap(null);
        map.setCenter(DEFAULT_CENTER); map.setZoom(11); filterAndRender(false);
    }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcGEQLapcmMIZpljmgf58msdesktWBXPc&libraries=places,geometry&callback=initMap"></script>
</body>
</html>
