<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Points de collecte des sapins ‚Äì Toulouse M√©tropole</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  html, body { margin:0; height:100%; font-family:Arial, sans-serif; background:#f7f7f7; }
  body { display:grid; grid-template-rows:auto auto 1fr auto; height:100dvh; }
  
  header { background:#2c3e50; color:white; padding:15px; text-align:center; }
  header h1 { margin:0; font-size:1.2rem; }
  
  #controls { background:white; padding:10px; border-bottom:1px solid #ddd; display:flex; flex-wrap:wrap; gap:10px; }
  #controls > * { flex:1; min-width:200px; padding:10px; font-size:14px; box-sizing:border-box; }
  #controls button { flex:0 0 auto; cursor:pointer; background:#e0e0e0; border:none; border-radius:4px; }
  #controls button:hover { background:#d0d0d0; }

  #map { width:100%; min-height:200px; }
  
  #results { background:white; padding:0; overflow-y:auto; border-top:1px solid #ddd; }
  .result-header { padding:10px; background:#f9f9f9; border-bottom:1px solid #eee; position:sticky; top:0; font-weight:bold; }
  .result-item { padding:12px; border-bottom:1px solid #eee; cursor:pointer; }
  .result-item:hover { background:#f0f8ff; }
  .result-dist { color:#2980b9; font-weight:bold; float:right; }

  footer { padding:5px; font-size:11px; text-align:center; color:#888; background:#eee; }
</style>
</head>

<body>

<header>
  <h1>üå≤ Points de collecte des sapins</h1>
</header>

<div id="controls">
  <input id="address" type="text" placeholder="üìç Entrez votre adresse">
  <select id="municipality">
    <option value="">Toutes les communes</option>
  </select>
  <button id="use-location" title="Ma position">üìç</button>
  <button id="reset" title="R√©initialiser">üîÑ</button>
</div>

<div id="map"></div>

<div id="results">
  <div class="result-header">Points √† proximit√©</div>
  <div id="results-list"></div>
</div>

<footer>Donn√©es Toulouse M√©tropole ‚Äì Open Data</footer>

<script>
let map, userMarker;
let markers = [];
let allPoints = [];
let userLocation = null;

// Initial center (Place du Capitole)
const DEFAULT_CENTER = { lat: 43.6045, lng: 1.444 };

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: DEFAULT_CENTER,
    zoom: 12,
    mapTypeControl: false,
    fullscreenControl: false,
    streetViewControl: false
  });

  setupSearch();
  loadDataset(); // Load data immediately
  
  // Controls
  document.getElementById("municipality").addEventListener("change", filterAndRender);
  document.getElementById("reset").addEventListener("click", resetApp);
}

async function loadDataset() {
  try {
    // 1. Fetch data (limit raised to 500 to catch everything)
    const url = "https://toulouse-metropole.opendatasoft.com/api/records/1.0/search/?dataset=collecte-des-sapins-de-noel&rows=500";
    const response = await fetch(url);
    const data = await response.json();

    // 2. Map data simply
    allPoints = data.records
      .filter(r => r.geometry)
      .map(r => ({
        name: r.fields.nom || "Point de collecte",
        address: r.fields.adresse || "Adresse non pr√©cis√©e",
        commune: r.fields.commune || r.fields.pole || "Toulouse", // Use existing field!
        lat: r.geometry.coordinates[1],
        lng: r.geometry.coordinates[0],
        marker: null
      }));

    populateDropdown();
    filterAndRender(); // Show all points initially

  } catch (err) {
    console.error("Erreur chargement donn√©es:", err);
    alert("Impossible de charger les donn√©es.");
  }
}

function filterAndRender() {
  // Clear old markers
  markers.forEach(m => m.setMap(null));
  markers = [];

  const selectedCommune = document.getElementById("municipality").value;
  const listContainer = document.getElementById("results-list");
  listContainer.innerHTML = "";

  // Filter
  const visiblePoints = selectedCommune 
    ? allPoints.filter(p => p.commune === selectedCommune) 
    : allPoints;

  // Calculate distances if user location exists
  if (userLocation) {
    visiblePoints.forEach(p => {
      p.distance = google.maps.geometry.spherical.computeDistanceBetween(
        userLocation, new google.maps.LatLng(p.lat, p.lng)
      );
    });
    visiblePoints.sort((a, b) => a.distance - b.distance);
  }

  // Create Markers & List
  visiblePoints.forEach((p, index) => {
    // A. Create Marker
    const marker = new google.maps.Marker({
      position: { lat: p.lat, lng: p.lng },
      map: map,
      title: p.name,
      // Use SVG for clean, fast icons
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 6,
        fillColor: "#27ae60",
        fillOpacity: 1,
        strokeWeight: 2,
        strokeColor: "#ffffff",
      }
    });
    
    // Click listener for marker
    marker.addListener("click", () => {
      highlightPoint(p, marker);
    });

    p.marker = marker;
    markers.push(marker);

    // B. Create List Item (limit list to 20 to keep DOM light)
    if (index < 20) {
      const el = document.createElement("div");
      el.className = "result-item";
      const distText = p.distance ? `<span class="result-dist">${(p.distance/1000).toFixed(1)} km</span>` : "";
      
      el.innerHTML = `
        ${distText}
        <strong>${p.name}</strong><br>
        <small>${p.address}, ${p.commune}</small>
      `;
      el.onclick = () => highlightPoint(p, marker);
      listContainer.appendChild(el);
    }
  });

  // If filtering, fit bounds
  if (markers.length > 0 && !userLocation) {
    const bounds = new google.maps.LatLngBounds();
    markers.forEach(m => bounds.extend(m.getPosition()));
    map.fitBounds(bounds);
  }
}

function highlightPoint(point, marker) {
  map.panTo({ lat: point.lat, lng: point.lng });
  map.setZoom(16);
  // Simple animation
  marker.setAnimation(google.maps.Animation.BOUNCE);
  setTimeout(() => marker.setAnimation(null), 1400);
}

function setupSearch() {
  const input = document.getElementById("address");
  const autocomplete = new google.maps.places.Autocomplete(input, {
    componentRestrictions: { country: "fr" }
  });

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;
    setUserLocation(place.geometry.location);
  });

  document.getElementById("use-location").onclick = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const loc = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          setUserLocation(loc);
        },
        () => alert("G√©olocalisation refus√©e ou impossible.")
      );
    }
  };
}

function setUserLocation(latLng) {
  userLocation = latLng;
  
  if (userMarker) userMarker.setMap(null);
  userMarker = new google.maps.Marker({
    position: userLocation,
    map: map,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 8,
      fillColor: "#2980b9", // Blue for user
      fillOpacity: 1,
      strokeWeight: 3,
      strokeColor: "white"
    },
    zIndex: 999
  });

  map.panTo(userLocation);
  map.setZoom(14);
  filterAndRender(); // Re-sort list by distance
}

function populateDropdown() {
  const select = document.getElementById("municipality");
  const communes = [...new Set(allPoints.map(p => p.commune))].sort();
  communes.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.innerText = c;
    select.appendChild(opt);
  });
}

function resetApp() {
  document.getElementById("address").value = "";
  document.getElementById("municipality").value = "";
  userLocation = null;
  if (userMarker) userMarker.setMap(null);
  map.setCenter(DEFAULT_CENTER);
  map.setZoom(12);
  filterAndRender();
}
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcGEQLapcmMIZpljmgf58msdesktWBXPc&libraries=places,geometry&callback=initMap">
</script>

</body>
</html>
