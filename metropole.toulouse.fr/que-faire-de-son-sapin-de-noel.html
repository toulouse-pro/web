<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Points de collecte Sapins - Toulouse M√©tropole</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
  /* --- RESET & LAYOUT --- */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body {
    margin: 0; padding: 0;
    height: 100%; width: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* --- HEADER --- */
  header {
    background: #2c3e50;
    color: white;
    padding: 12px 15px;
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    z-index: 20;
    display: flex;
    align-items: center;
  }
  header h1 { margin: 0; font-size: 1.1rem; font-weight: 600; }

  /* --- CONTROLS --- */
  #controls {
    background: white;
    padding: 12px;
    border-bottom: 1px solid #ddd;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    flex-shrink: 0;
    z-index: 10;
    align-items: center;
  }

  #input-group {
    display: flex;
    flex: 1;
    gap: 10px;
    flex-wrap: wrap;
    min-width: 280px;
  }

  input, select {
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    flex: 1;
    height: 42px;
    min-width: 130px;
    background: white;
  }

  #btn-group { display: flex; gap: 8px; }

  button {
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    padding: 0 16px;
    height: 42px;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    transition: background 0.2s;
  }

  #btn-loc {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
  }
  #btn-loc:active { background: #c8e6c9; }

  #btn-reset {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
  }
  #btn-reset:active { background: #ffcdd2; }

  /* --- MAIN CONTENT --- */
  #content-area {
    display: flex;
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  #map { flex: 1; height: 100%; width: 100%; }

  #results-container {
    width: 320px;
    background: white;
    border-left: 1px solid #ddd;
    display: none;
    flex-direction: column;
    overflow-y: auto;
    box-shadow: -2px 0 5px rgba(0,0,0,0.05);
  }

  .list-header {
    background: #f1f3f5;
    padding: 10px 15px;
    font-size: 0.85rem;
    font-weight: 700;
    color: #495057;
    position: sticky;
    top: 0;
    border-bottom: 1px solid #e9ecef;
  }

  .result-item {
    padding: 14px 15px;
    border-bottom: 1px solid #f1f1f1;
    cursor: pointer;
    transition: background 0.1s;
  }
  .result-item:hover { background: #f8f9fa; }
  
  .result-name { font-weight: 600; color: #343a40; margin-bottom: 4px; display: block; }
  .result-addr { font-size: 0.85rem; color: #868e96; display: block; }
  .dist-badge {
    float: right;
    background: #e3f2fd;
    color: #1976d2;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* --- POPUP FIXES --- */
  /* Remove Google Maps default scrollbars and padding overrides */
  .gm-style-iw-d { overflow: hidden !important; }
  .gm-style-iw-c { padding: 0 !important; max-width: 300px !important; }
  .gm-style-iw-t::after { display: none; } /* Optional: hides the little triangle if needed */

  .custom-popup {
    padding: 15px;
    min-width: 220px;
  }

  .custom-popup h3 { 
    margin: 0 0 5px; 
    font-size: 15px; 
    color: #2c3e50; 
    font-weight: 700;
  }
  
  .custom-popup p { 
    margin: 0 0 12px; 
    font-size: 13px; 
    color: #666; 
    line-height: 1.4; 
  }
  
  .popup-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #1976d2;
    color: white !important;
    text-decoration: none;
    padding: 10px 0;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    width: 100%;
    transition: background 0.2s;
  }
  .popup-btn:hover { background: #1565c0; }

  /* --- MOBILE TWEAKS --- */
  @media (max-width: 768px) {
    #controls { gap: 8px; }
    #input-group { min-width: 100%; gap: 8px; }
    #btn-group { width: 100%; gap: 8px; }
    button { flex: 1; justify-content: center; }
    
    #content-area { flex-direction: column; }
    #results-container {
      width: 100%;
      height: 40%;
      border-left: none;
      border-top: 1px solid #ddd;
    }
  }
</style>
</head>

<body>

<header>
  <h1>üå≤ Collecte Sapins</h1>
</header>

<div id="controls">
  <div id="input-group">
    <input id="address" type="text" placeholder="Entrez votre adresse...">
    <select id="municipality">
      <option value="">Toutes les communes</option>
    </select>
  </div>
  
  <div id="btn-group">
    <button id="btn-loc">üìç Ma position</button>
    <button id="btn-reset">üóëÔ∏è Tout effacer</button>
  </div>
</div>

<div id="content-area">
  <div id="map"></div>
  <div id="results-container">
    <div class="list-header">Points √† proximit√©</div>
    <div id="results-list"></div>
  </div>
</div>

<script>
let map, userMarker, infoWindow;
let markers = [];
let allPoints = [];

// STATE
let userLocation = null; // Coordinates object
let userAddressString = null; // String address (if typed)

// Default: Place du Capitole
const DEFAULT_CENTER = { lat: 43.6045, lng: 1.444 };

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: DEFAULT_CENTER,
    zoom: 11,
    disableDefaultUI: false,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false,
    clickableIcons: false,
    gestureHandling: "greedy" // Better mobile handling
  });

  infoWindow = new google.maps.InfoWindow();

  setupAutocomplete();
  loadDataset();
  
  // Controls
  document.getElementById("municipality").addEventListener("change", () => filterAndRender(true));
  document.getElementById("btn-reset").addEventListener("click", resetAll);
  document.getElementById("btn-loc").addEventListener("click", useGeolocation);
}

/* --- DATA LOADING --- */
async function loadDataset() {
  try {
    // 1000 rows to ensure we get ALL towns
    const url = "https://toulouse-metropole.opendatasoft.com/api/records/1.0/search/?dataset=collecte-des-sapins-de-noel&rows=1000";
    const res = await fetch(url);
    const data = await res.json();

    allPoints = data.records
      .filter(r => r.geometry)
      .map(r => {
        // CLEANUP: Title Case for cities (e.g. "BALMA" -> "Balma")
        // Checks 'commune', 'pole' or defaults to Toulouse
        let rawCity = r.fields.commune || r.fields.pole || "Toulouse";
        
        // Normalize: Lowercase then capitalize first letter of words
        let niceCity = rawCity.toLowerCase().split(/[\s-]+/).map(word => 
          word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');

        // Manual fixes for specific nuances if needed (e.g. L'union)
        if(niceCity.includes("L'union")) niceCity = "L'Union";

        return {
          name: r.fields.nom || "Point de collecte",
          address: r.fields.adresse || "Adresse non pr√©cis√©e",
          commune: niceCity, 
          lat: r.geometry.coordinates[1],
          lng: r.geometry.coordinates[0],
          marker: null
        };
      });

    populateDropdown();
    filterAndRender(false); // Render all points initially

  } catch (e) {
    alert("Erreur: Impossible de charger les donn√©es des sapins.");
    console.error(e);
  }
}

/* --- LOGIC --- */

function filterAndRender(shouldFitBounds) {
  // 1. Clear Map
  markers.forEach(m => m.setMap(null));
  markers = [];
  infoWindow.close();

  const selectedCommune = document.getElementById("municipality").value;
  const listDiv = document.getElementById("results-list");
  listDiv.innerHTML = "";

  // 2. Filter Logic
  let visiblePoints = allPoints;
  if (selectedCommune) {
    visiblePoints = allPoints.filter(p => p.commune === selectedCommune);
  }

  // 3. Sort by Distance (if user has a location)
  // We only sort if we are NOT viewing a specific town, OR if we want to sort the specific town list by distance from user
  if (userLocation) {
    visiblePoints.forEach(p => {
      p.distance = google.maps.geometry.spherical.computeDistanceBetween(
        userLocation, new google.maps.LatLng(p.lat, p.lng)
      );
    });
    visiblePoints.sort((a, b) => a.distance - b.distance);
  } else {
    // Alphabetical sort if no location
    visiblePoints.sort((a, b) => a.name.localeCompare(b.name));
  }

  // 4. Create Markers
  const bounds = new google.maps.LatLngBounds();

  visiblePoints.forEach((p, idx) => {
    const marker = new google.maps.Marker({
      position: { lat: p.lat, lng: p.lng },
      map: map,
      title: p.name,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 6,
        fillColor: "#27ae60",
        fillOpacity: 1,
        strokeWeight: 1,
        strokeColor: "white"
      }
    });

    marker.addListener("click", () => openPopup(p, marker));
    
    p.marker = marker;
    markers.push(marker);
    bounds.extend(marker.getPosition());

    // 5. Populate List (Limit to 50 items for performance)
    if (idx < 50) {
      document.getElementById("results-container").style.display = "flex";
      
      const item = document.createElement("div");
      item.className = "result-item";
      
      const distHtml = p.distance 
        ? `<span class="dist-badge">${(p.distance/1000).toFixed(1)} km</span>` 
        : "";

      item.innerHTML = `
        ${distHtml}
        <span class="result-name">${p.name}</span>
        <span class="result-addr">${p.address}</span>
      `;
      
      item.onclick = () => {
        openPopup(p, marker);
        map.panTo(marker.getPosition());
        map.setZoom(16);
      };
      
      listDiv.appendChild(item);
    }
  });

  // 6. Camera Movement Logic
  // If we should fit bounds (e.g. Dropdown changed), DO IT regardless of userLocation
  if (shouldFitBounds && markers.length > 0) {
    map.fitBounds(bounds);
    
    // Prevent zooming in too close if there is only 1 point
    const listener = google.maps.event.addListener(map, "idle", () => { 
      if (map.getZoom() > 16) map.setZoom(16); 
      google.maps.event.removeListener(listener); 
    });
  }
}

function openPopup(p, marker) {
  // GENERATE SMART ITINERARY LINK (Universal Google Maps URL)
  let originParam = "";
  
  if (userAddressString) {
    originParam = `&origin=${encodeURIComponent(userAddressString)}`;
  } else if (userLocation) {
    originParam = `&origin=${userLocation.lat()},${userLocation.lng()}`;
  }

  // Use the universal API link
  const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}${originParam}&travelmode=driving`;

  const content = `
    <div class="custom-popup">
      <h3>${p.name}</h3>
      <p>
        ${p.address}<br>
        <strong>${p.commune}</strong>
      </p>
      <a href="${mapsUrl}" target="_blank" class="popup-btn">
        üöò Itin√©raire
      </a>
    </div>
  `;
  
  infoWindow.setContent(content);
  infoWindow.open(map, marker);
}

/* --- HELPERS --- */

function populateDropdown() {
  const select = document.getElementById("municipality");
  // Create a Set to remove duplicates, then sort alphabetically
  const cities = [...new Set(allPoints.map(p => p.commune))].sort();
  
  cities.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });
}

function setupAutocomplete() {
  const input = document.getElementById("address");
  input.addEventListener("keydown", (e) => { if(e.key === "Enter") e.preventDefault(); });

  const autocomplete = new google.maps.places.Autocomplete(input, {
    componentRestrictions: { country: "fr" },
    fields: ["geometry", "formatted_address"]
  });

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;
    
    userAddressString = place.formatted_address; 
    setUserLocation(place.geometry.location);
  });
}

function useGeolocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const loc = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        userAddressString = null; 
        setUserLocation(loc);
        
        const btn = document.getElementById("btn-loc");
        btn.textContent = "‚úÖ Trouv√©";
        setTimeout(() => btn.textContent = "üìç Ma position", 2000);
      },
      () => alert("Impossible d'obtenir votre position.")
    );
  } else {
    alert("Votre navigateur ne supporte pas la g√©olocalisation.");
  }
}

function setUserLocation(loc) {
  userLocation = loc;
  
  if (userMarker) userMarker.setMap(null);
  userMarker = new google.maps.Marker({
    position: userLocation,
    map: map,
    title: "Vous √™tes ici",
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 8,
      fillColor: "#4285F4",
      fillOpacity: 1,
      strokeWeight: 2,
      strokeColor: "white"
    },
    zIndex: 999
  });

  // Reset filter when we set a new location to see "what is near me"
  document.getElementById("municipality").value = "";
  
  map.panTo(userLocation);
  map.setZoom(14);
  
  filterAndRender(false);
}

function resetAll() {
  document.getElementById("address").value = "";
  document.getElementById("municipality").value = "";
  document.getElementById("results-container").style.display = "none";
  
  userLocation = null;
  userAddressString = null;
  if (userMarker) userMarker.setMap(null);
  
  map.setCenter(DEFAULT_CENTER);
  map.setZoom(11);
  
  filterAndRender(false);
}

</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcGEQLapcmMIZpljmgf58msdesktWBXPc&libraries=places,geometry&callback=initMap">
</script>

</body>
</html>
