<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Points de collecte des sapins – Toulouse Métropole</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f7f7f7; }
    header { background:#1f6fb2; color:white; padding:12px; }
    header h1 { margin:0; font-size:18px; }

    #controls { background:white; padding:10px; }
    #controls select,
    #controls input,
    #controls button {
      width:100%;
      padding:10px;
      font-size:15px;
      margin-bottom:8px;
      box-sizing:border-box;
    }

    #map-container {
      background:#eaeaea;
      text-align:center;
      padding:20px;
    }

    #map {
      width:100%;
      height:42vh;
      min-height:300px;
      display:none;
    }

    #results { background:white; padding:10px; font-size:14px; }
    .result {
      padding:8px;
      border-bottom:1px solid #eee;
      cursor:pointer;
    }
    .result:hover { background:#f0f0f0; }

    footer {
      padding:10px;
      font-size:12px;
      text-align:center;
      color:#666;
    }
  </style>
</head>

<body>

<header>
  <h1>Points de collecte des sapins de Noël – Toulouse Métropole</h1>
</header>

<div id="controls">
  <select id="municipality">
    <option value="">Toutes les communes</option>
  </select>

  <input id="address" type="text" placeholder="Entrez votre adresse">
  <button id="use-location">Utiliser ma position</button>
  <button id="reset">Réinitialiser</button>
</div>

<div id="map-container">
  <button id="load-map">Afficher la carte</button>
  <div id="map"></div>
</div>

<div id="results">
  <strong>Points les plus proches :</strong>
</div>

<footer>
  Données officielles Toulouse Métropole – Carte non officielle, à titre informatif
</footer>

<script>
  let map, userMarker, highlightedMarker;
  let userLocation = null;
  let allPoints = [], filteredPoints = [], markers = [];
  let mapLoaded = false;

  const ICONS = {
    normal: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
    best: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
    user: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
  };

  document.getElementById("load-map").addEventListener("click", loadMap);
  document.getElementById("address").addEventListener("focus", loadMap);
  document.getElementById("use-location").addEventListener("click", loadMap);

  document.getElementById("reset").addEventListener("click", () => {
    document.getElementById("municipality").value = "";
    document.getElementById("address").value = "";
    userLocation = null;
    if (userMarker) userMarker.setMap(null);
    clearMarkers();
    createMarkers(allPoints);
    document.getElementById("results").innerHTML =
      "<strong>Points les plus proches :</strong>";
  });

  function loadMap() {
    if (mapLoaded) return;
    mapLoaded = true;

    document.getElementById("map").style.display = "block";
    document.getElementById("load-map").style.display = "none";

    const script = document.createElement("script");
    script.src =
      "https://maps.googleapis.com/maps/api/js?key=AIzaSyCcGEQLapcmMIZpljmgf58msdesktWBXPc&libraries=places,geometry&callback=initMap";
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);
  }

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center:{ lat:43.6045, lng:1.444 },
      zoom:12,
      gestureHandling:"greedy"
    });

    loadDataset();

    const autocomplete = new google.maps.places.Autocomplete(
      document.getElementById("address")
    );
    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) return;
      userLocation = place.geometry.location;
      placeUserMarker(userLocation);
      autoSelectMunicipality(place.address_components);
      updateResults();
    });

    document.getElementById("use-location").onclick = () => {
      navigator.geolocation.getCurrentPosition(pos => {
        userLocation = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };
        placeUserMarker(userLocation);
        reverseGeocodeMunicipality(userLocation);
        updateResults();
      });
    };

    document.getElementById("municipality").onchange = applyMunicipalityFilter;
  }

  function loadDataset() {
    fetch(
      "https://toulouse-metropole.opendatasoft.com/api/records/1.0/search/?dataset=collecte-des-sapins-de-noel&rows=500"
    )
      .then(r => r.json())
      .then(data => {
        const communes = new Set();
        data.records.forEach(r => {
          if (!r.geometry) return;
          const f = r.fields || {};
          const commune =
            f.commune_nom || f.nom_commune || f.commune || "";
          allPoints.push({
            name: f.nom || "Point de collecte",
            address: f.adresse || "",
            municipality: commune,
            lat: r.geometry.coordinates[1],
            lng: r.geometry.coordinates[0]
          });
          if (commune) communes.add(commune);
        });
        populateMunicipalities(communes);
        createMarkers(allPoints);
      });
  }

  function populateMunicipalities(communes) {
    const select = document.getElementById("municipality");
    [...communes].sort().forEach(c => {
      const o = document.createElement("option");
      o.value = c;
      o.textContent = c;
      select.appendChild(o);
    });
  }

  function applyMunicipalityFilter() {
    const val = document.getElementById("municipality").value;
    filteredPoints = val
      ? allPoints.filter(p => p.municipality === val)
      : allPoints;
    clearMarkers();
    createMarkers(filteredPoints);
    updateResults();
  }

  function createMarkers(list) {
    const bounds = new google.maps.LatLngBounds();
    list.forEach(p => {
      const m = new google.maps.Marker({
        position:{ lat:p.lat, lng:p.lng },
        map,
        icon:ICONS.normal
      });
      markers.push(m);
      bounds.extend(m.getPosition());
    });
    if (!bounds.isEmpty()) map.fitBounds(bounds);
  }

  function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
    resetHighlight();
  }

  function placeUserMarker(loc) {
    if (userMarker) userMarker.setMap(null);
    userMarker = new google.maps.Marker({
      position:loc,
      map,
      icon:ICONS.user
    });
  }

  function updateResults() {
    resetHighlight();
    if (!userLocation) return;

    const list = filteredPoints.length ? filteredPoints : allPoints;
    const sorted = list.map((p,i) => ({
      ...p,
      index:i,
      d: google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(userLocation),
        new google.maps.LatLng(p.lat,p.lng)
      )
    })).sort((a,b) => a.d - b.d);

    highlightedMarker = markers[sorted[0].index];
    highlightedMarker.setIcon(ICONS.best);
  }

  function resetHighlight() {
    if (highlightedMarker) {
      highlightedMarker.setIcon(ICONS.normal);
      highlightedMarker = null;
    }
  }

  function autoSelectMunicipality(components) {
    const c = components.find(a => a.types.includes("locality"));
    if (!c) return;
    const select = document.getElementById("municipality");
    [...select.options].forEach(o => {
      if (o.value === c.long_name) select.value = o.value;
    });
    applyMunicipalityFilter();
  }

  function reverseGeocodeMunicipality(loc) {
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ location: loc }, (res,status) => {
      if (status !== "OK") return;
      autoSelectMunicipality(res[0].address_components);
    });
  }
</script>

</body>
</html>
